name: ðŸš€ Staging/Production Deploy

on:
  release:
    types: [released, prereleased]

env:
  ARTIFACT_NAME: invest-v3-${{ github.ref_name }}.zip

permissions:
  contents: read
  deployments: write

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.action != 'prereleased'
    steps:
      - name: 'ðŸ“¥ Checkout Code from Release Tag'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: 'ðŸ”¨ Build App'
        id: build
        uses: ./.github/actions/build-app
        with:
          build-args: --mode mainnet
          github-token: ${{ secrets.GITHUB_TOKEN }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.event.action == 'prereleased' && 'staging' || 'production' }}
      url: ${{ steps.deploy.outputs.deployment-url }}
    steps:
      - name: 'ðŸ“¥ Checkout Code'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: 'ðŸš€ Deploy App'
        id: deploy
        uses: ./.github/actions/deploy-app
        with:
          environment: ${{ github.event.action == 'prereleased' && 'staging' || 'prod' }}
          cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare-account-id: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

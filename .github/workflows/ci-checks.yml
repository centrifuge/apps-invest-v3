name: 'ğŸ” CI Checks'

on:
  pull_request:

jobs:
  syntax:
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ“¥ Checkout Code'
        uses: actions/checkout@v4
      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10
  
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
  
      - name: Install dependencies
        shell: sh
        run: pnpm install --frozen-lockfile
      - name: TypeScript type-check
        shell: bash
        run: |
          set -euo pipefail
          pnpm -w exec tsc -v
          mapfile -t CONFIGS < <(git ls-files '**/tsconfig.json' ':!:**/node_modules/**' ':!:**/dist/**' || true)
          if [ ${#CONFIGS[@]} -eq 0 ]; then
            echo "No tsconfig.json files found"; exit 0;
          fi
          for cfg in "${CONFIGS[@]}"; do
            echo "TS check: $cfg"
            pnpm -w exec tsc --noEmit -p "$cfg"
          done
  
      - name: Lint
        shell: sh
        run: pnpm -w run lint
  osv-dependency-sec-check:
    uses: "google/osv-scanner-action/.github/workflows/osv-scanner-reusable-pr.yml@v2.2.2"
    with:
      fail-on-vuln: false

  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: $((${{ github.event.pull_request.commits }}+2))
          # Shallow clone to speed up the action
      - name: TruffleHog scan
        uses: trufflesecurity/trufflehog@v3.90.4
        with:
          path: .
          extra_args: --results=verified,unknown
          upload-sarif: false
        continue-on-error: true

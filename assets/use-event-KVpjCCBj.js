import{c as X}from"./create-split-props-BLHDZ2ef.js";import{r as o,T as H,a as K,U as Q,V as w,W as k,X as h,Y as T,Z as _,_ as tt,$ as et,a0 as nt}from"./iframe-Bh4nsEqh.js";import{r as P}from"./index-Bf1ftP2J.js";const[it,lt]=X({name:"EnvironmentContext",hookName:"useEnvironmentContext",providerName:"<EnvironmentProvider />",strict:!1,defaultValue:{getRootNode:()=>document,getDocument:()=>document,getWindow:()=>window}}),[dt,gt]=X({name:"LocaleContext",hookName:"useLocaleContext",providerName:"<LocaleProvider />",strict:!1,defaultValue:{dir:"ltr",locale:"en-US"}});var Y=typeof globalThis.document<"u"?o.useLayoutEffect:o.useEffect;function j(t){const u=t().value??t().defaultValue,a=t().isEqual??Object.is,[c]=o.useState(u),[l,R]=o.useState(c),C=t().value!==void 0,E=o.useRef(l);E.current=C?t().value:l;const m=o.useRef(E.current);Y(()=>{m.current=E.current},[l,t().value]);const y=v=>{var N,M;const i=m.current,d=T(v)?v(i):v;t().debug&&console.log(`[bindable > ${t().debug}] setValue`,{next:d,prev:i}),C||R(d),a(d,i)||(M=(N=t()).onChange)==null||M.call(N,d,i)};function V(){return C?t().value:l}return{initial:c,ref:E,get:V,set(v){(t().sync?P.flushSync:h)(()=>y(v))},invoke(v,i){var d,N;(N=(d=t()).onChange)==null||N.call(d,v,i)},hash(v){var i,d;return((d=(i=t()).hash)==null?void 0:d.call(i,v))??String(v)}}}j.cleanup=t=>{o.useEffect(()=>t,[])};j.ref=t=>{const u=o.useRef(t);return{get:()=>u.current,set:a=>{u.current=a}}};function rt(t){const u=o.useRef(t);return{get(a){return u.current[a]},set(a,c){u.current[a]=c}}}var ut=(t,u)=>{const a=o.useRef(!1),c=o.useRef(!1);o.useEffect(()=>{if(a.current&&c.current)return u();c.current=!0},[...(t??[]).map(l=>typeof l=="function"?l():l)]),o.useEffect(()=>(a.current=!0,()=>{a.current=!1}),[])};function vt(t,u={}){var I,J,U,W;const a=o.useMemo(()=>{const{id:n,ids:e,getRootNode:r}=u;return H({id:n,ids:e,getRootNode:r})},[u]),c=(...n)=>{t.debug&&console.log(...n)},l=((I=t.props)==null?void 0:I.call(t,{props:K(u),scope:a}))??u,R=st(l),C=(J=t.context)==null?void 0:J.call(t,{prop:R,bindable:j,scope:a,flush:B,getContext(){return m},getComputed(){return z},getRefs(){return M}}),E=Z(C),m={get(n){var e;return(e=E.current)==null?void 0:e[n].ref.current},set(n,e){var r;(r=E.current)==null||r[n].set(e)},initial(n){var e;return(e=E.current)==null?void 0:e[n].initial},hash(n){var r,s;const e=(r=E.current)==null?void 0:r[n].get();return(s=E.current)==null?void 0:s[n].hash(e)}},y=o.useRef(new Map),V=o.useRef(null),v=o.useRef(null),i=o.useRef({type:""}),d=()=>({...i.current,current(){return i.current},previous(){return v.current}}),N=()=>({...x,matches(...n){return n.includes(x.ref.current)},hasTag(n){var e,r;return!!((r=(e=t.states[x.ref.current])==null?void 0:e.tags)!=null&&r.includes(n))}}),M=rt(((U=t.refs)==null?void 0:U.call(t,{prop:R,context:m}))??{}),b=()=>({state:N(),context:m,event:d(),prop:R,send:F,action:L,guard:$,track:ut,refs:M,computed:z,flush:B,scope:a,choose:A}),L=n=>{const e=T(n)?n(b()):n;if(!e)return;const r=e.map(s=>{var g,S;const f=(S=(g=t.implementations)==null?void 0:g.actions)==null?void 0:S[s];return f||_(`[zag-js] No implementation found for action "${JSON.stringify(s)}"`),f});for(const s of r)s==null||s(b())},$=n=>{var e,r;return T(n)?n(b()):(r=(e=t.implementations)==null?void 0:e.guards)==null?void 0:r[n](b())},O=n=>{const e=T(n)?n(b()):n;if(!e)return;const r=e.map(f=>{var S,p;const g=(p=(S=t.implementations)==null?void 0:S.effects)==null?void 0:p[f];return g||_(`[zag-js] No implementation found for effect "${JSON.stringify(f)}"`),g}),s=[];for(const f of r){const g=f==null?void 0:f(b());g&&s.push(g)}return()=>s.forEach(f=>f==null?void 0:f())},A=n=>tt(n).find(e=>{let r=!e.guard;return et(e.guard)?r=!!$(e.guard):T(e.guard)&&(r=e.guard(b())),r}),z=n=>{Q(t.computed,()=>"[zag-js] No computed object found on machine");const e=t.computed[n];return e({context:m,event:d(),prop:R,refs:M,scope:a,computed:z})},x=j(()=>({defaultValue:t.initialState({prop:R}),onChange(n,e){var s,f,g,S;if(e){const p=y.current.get(e);p==null||p(),y.current.delete(e)}e&&L((s=t.states[e])==null?void 0:s.exit),L((f=V.current)==null?void 0:f.actions);const r=O((g=t.states[n])==null?void 0:g.effects);if(r&&y.current.set(n,r),e===k){L(t.entry);const p=O(t.effects);p&&y.current.set(k,p)}L((S=t.states[n])==null?void 0:S.entry)}})),D=o.useRef(void 0),q=o.useRef(w.NotStarted);Y(()=>{queueMicrotask(()=>{const r=q.current===w.Started;q.current=w.Started,c(r?"rehydrating...":"initializing...");const s=D.current??x.initial;x.invoke(s,r?x.get():k)});const n=y.current,e=x.ref.current;return()=>{c("unmounting..."),D.current=e,q.current=w.Stopped,n.forEach(r=>r==null?void 0:r()),y.current=new Map,V.current=null,queueMicrotask(()=>{L(t.exit)})}},[]);const G=()=>"ref"in x?x.ref.current:x.get(),F=n=>{queueMicrotask(()=>{var S,p;if(q.current!==w.Started)return;v.current=i.current,i.current=n,c("send",n);let e=G();const r=((S=t.states[e].on)==null?void 0:S[n.type])??((p=t.on)==null?void 0:p[n.type]),s=A(r);if(!s)return;V.current=s;const f=s.target??e;c("transition",s);const g=f!==e;g?P.flushSync(()=>x.set(f)):s.reenter&&!g?x.invoke(e,e):L(s.actions??[])})};return(W=t.watch)==null||W.call(t,b()),{state:N(),send:F,context:m,prop:R,scope:a,refs:M,computed:z,event:d(),getStatus:()=>q.current}}function Z(t){const u=o.useRef(t);return u.current=t,u}function st(t){const u=Z(t);return function(c){return u.current[c]}}function B(t){queueMicrotask(()=>{P.flushSync(()=>t())})}var Rt=nt(t=>t);function xt(t,u={}){const{sync:a=!1}=u,c=ot(t);return o.useCallback((...l)=>{var R;return a?queueMicrotask(()=>{var C;return(C=c.current)==null?void 0:C.call(c,...l)}):(R=c.current)==null?void 0:R.call(c,...l)},[a,c])}function ot(t){const u=o.useRef(t);return u.current=t,u}export{gt as a,vt as b,xt as c,Rt as n,lt as u};
